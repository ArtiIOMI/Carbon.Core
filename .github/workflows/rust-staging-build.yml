###
### Copyright (c) 2023 Carbon Community 
### All rights reserved
###
name: Rust (Staging) Build
concurrency: build-rust-staging

on:
  workflow_dispatch:

  schedule:
    - cron: '00 19 * * *'

jobs:
  bootstrap:
    name: 🥾 Bootstrap
    runs-on: ubuntu-latest

    outputs:
      date:    ${{ steps.step1.outputs.date }}
      clock:   ${{ steps.step1.outputs.clock }}
      tag:     ${{ steps.step1.outputs.tag }}
      ref:     ${{ steps.step1.outputs.ref }}
      wipe:    ${{ steps.step1.outputs.wipe }}
      version: ${{ steps.step1.outputs.version }}

    steps:
      #- name: Log environment
      #  uses: crazy-max/ghaction-dump-context@v1

      - name: 🔗 Checkout source code from github
        uses: actions/checkout@v3
        with:
          ref: rust_beta/staging

      - name: 📅 Prepare the environment
        id: step1
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "clock=$(date +'%H:%M:%S')" >> $GITHUB_OUTPUT
          echo "tag=$(date +'%Yd%j')" >> $GITHUB_OUTPUT
          echo "ref=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "wipe=$( [ $(date +%u) -eq 4 ] && [ $(date +%d) -le 7 ] && echo true || echo false )" >> $GITHUB_OUTPUT
          echo "version=$(date +'0.%Y.%q%j.%M%S')" >> $GITHUB_OUTPUT

  # BUILD LINUX ----------------------------------------------------------------
  build-linux:
    name: 🐧 Linux
    needs: bootstrap
    runs-on: ubuntu-latest
    continue-on-error: true

    outputs:
      wipe: ${{ needs.bootstrap.outputs.wipe }}
      artifact: build-staging-${{ needs.bootstrap.outputs.ref }}-linux
      build_info: Built at ${{ needs.bootstrap.outputs.date }} ${{ needs.bootstrap.outputs.clock }} based on commit ${{ needs.bootstrap.outputs.ref }}.
    
    steps:
    - name: 🔗 Checkout source code from github
      uses: actions/checkout@v3
      with:
        ref: rust_beta/staging

    - name: 🛤️ Setup the dotnet build environment
      uses: actions/setup-dotnet@v2
      with:
        dotnet-version: 6.0.x

    - name: 🔨 Setup the Carbon build environment
      shell: bash
      run: |
        ${GITHUB_WORKSPACE}/Tools/Build/linux/bootstrap.sh

    - name: 🔨 Setup the Carbon build environment (Staging)
      shell: bash
      run: |
        ${GITHUB_WORKSPACE}/Tools/Build/linux/update_staging.sh
        
    - name: 🐧 Built Carbon on Linux
      shell: bash
      run: |
        export VERSION=${{ needs.bootstrap.outputs.version }}
        ${GITHUB_WORKSPACE}/Tools/Build/linux/build.sh DebugUnix
        
    - name: ⬆️ Upload the artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-staging-linux
        path: |
          Release/Carbon.Linux.Debug.tar.gz
          Release/Carbon.Linux.Debug.info

  # BUILD WINDOWS --------------------------------------------------------------
  build-windows:
    name: 💻 Windows
    needs: bootstrap
    runs-on: windows-latest
    continue-on-error: true
    
    steps:
    - name: 🔗 Checkout source code from github
      uses: actions/checkout@v3
      with:
        ref: rust_beta/staging

    - name: 🛤️ Setup the dotnet build environment
      uses: actions/setup-dotnet@v2
      with:
        dotnet-version: 6.0.x

    - name: 🔨 Setup the Carbon build environment
      shell: cmd
      run: |
        %GITHUB_WORKSPACE%\Tools\Build\win\bootstrap.bat

    - name: 🔨 Setup the Carbon build environment (Staging)
      shell: cmd
      run: |
        %GITHUB_WORKSPACE%\Tools\Build\win\update_staging.bat
        
    - name: 🔨 Built Carbon on Windows
      shell: cmd
      run: |
        set VERSION=${{ needs.bootstrap.outputs.version }}
        %GITHUB_WORKSPACE%\Tools\Build\win\build.bat Debug

    - name: ⬆️ Upload the artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-staging-windows
        path: |
          Release/Carbon.Windows.Debug.zip
          Release/Carbon.Windows.Debug.info

  # BUILD WINDOWS --------------------------------------------------------------
  artifacts-windows:
    runs-on: windows-latest
    needs: build-windows
    continue-on-error: true
    steps:
      - name: Install Jekyll
        run: gem install jekyll
        
      - name: Build Jekyll site
        run: bundle exec jekyll build
        
      - name: Publish artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ruststaging
          path: |
            Release/Carbon.Windows.Debug.info
            Release/Carbon.Windows.Debug.zip
            Release/Carbon.Linux.Debug.info
            Release/Carbon.Linux.Debug.tar.gz
